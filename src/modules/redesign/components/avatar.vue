<template>
    <div>
        <h1>{{ lightbox.$sm('title') }}</h1>
        <div class="well pull-right" v-if="profile.image">
            <b>{{ lightbox.$sm('current') }}</b>
            <button class="btn btn-danger pull-right" @click="deleteAvatar">
                <font-awesome-icon :icon="faTrash"></font-awesome-icon>
            </button>
            <br />
            <img :src="profile.image" alt="" loading="lazy" />
        </div>
        <button @click="select" class="btn btn-success">
            {{ lightbox.$sm('select') }}
        </button>
        <button @click="submit" class="btn btn-success" :disabled="!imageFile">
            {{ lightbox.$sm('save') }}
        </button>
        <br />
        <b v-if="image">{{ lightbox.$sm('preview') }}:</b>
        <br />
        <img :src="image" alt="" />
    </div>
</template>

<script lang="ts">
import Vue from 'vue';

import { faTrash } from '@fortawesome/free-solid-svg-icons/faTrash';
import { useEventStore } from '@stores/event';

import type { IconDefinition } from '@fortawesome/fontawesome-svg-core';
import type { RedesignComponent } from 'typings/modules/Redesign';

type Component = RedesignComponent<
    'profile',
    'avatar',
    {
        faTrash: IconDefinition;
        image: string;
        imageFile: File | null;
        input: HTMLInputElement;
        eventStore: ReturnType<typeof useEventStore>;
    },
    {
        submit(): void;
        deleteAvatar(): void;
        select(): void;
    }
>;

export default Vue.extend<
    Component['Data'],
    Component['Methods'],
    Component['Computed'],
    Component['Props']
>({
    name: 'lssmv4-redesign-avatar-edit',
    data() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        return {
            faTrash,
            image: '',
            imageFile: null,
            input,
            eventStore: useEventStore(),
        };
    },
    methods: {
        submit() {
            if (!this.imageFile) return;
            const formData = new FormData();
            formData.append('utf8', 'âœ“');
            formData.append('_method', 'put');
            formData.append(
                'authenticity_token',
                this.profile.authenticity_token
            );
            formData.append(
                'avatar[image]',
                this.imageFile,
                this.imageFile.name
            );
            formData.append('commit', 'save');
            this.lightbox.apiStore
                .request(`/avatar/upload`, `redesign-avatar-edit`, {
                    credentials: 'include',
                    headers: {
                        'Accept':
                            'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                        'Upgrade-Insecure-Requests': '1',
                    },
                    referrer: new URL(
                        `avatar`,
                        window.location.origin
                    ).toString(),
                    body: formData,
                    method: 'POST',
                    mode: 'cors',
                })
                .then(({ url }) => {
                    const img = this.image;
                    this.image = '';
                    this.imageFile = null;
                    if (
                        !new URL(
                            this.url,
                            window.location.origin
                        ).searchParams.has('close-after-submit') ||
                        this.lightbox.noModal
                    )
                        return this.$set(this.lightbox, 'src', url);
                    this.eventStore.createAndDispatchEvent({
                        name: 'redesign-edit-avatar-submitted',
                        detail: {
                            img,
                        },
                    });
                    window.lightboxClose(this.lightbox.creation);
                });
        },
        deleteAvatar() {
            this.$set(this.lightbox, 'loading', true);
            this.lightbox.apiStore
                .request(`/avatar/delete`, `redesign-avatar-delete`, {
                    credentials: 'include',
                    referrer: new URL(
                        `avatar`,
                        window.location.origin
                    ).toString(),
                    method: 'GET',
                    mode: 'cors',
                })
                .then(() => {
                    this.$set(this.lightbox.data, 'image', '');
                    this.lightbox.finishLoading('avatar-deleted');
                    this.eventStore.createAndDispatchEvent({
                        name: 'redesign-edit-avatar-submitted',
                        detail: {
                            img: '',
                        },
                    });
                });
        },
        select() {
            this.input.click();
        },
    },
    props: {
        profile: {
            type: Object,
            required: true,
        },
        url: {
            type: String,
            required: true,
        },
        lightbox: {
            type: Object,
            required: true,
        },
        getSetting: {
            type: Function,
            required: true,
        },
        setSetting: {
            type: Function,
            required: true,
        },
    },
    watch: {
        profile() {
            this.lightbox.finishLoading('avatar-edit-updated');
        },
    },
    mounted() {
        this.input.addEventListener('change', () => {
            if (!this.input.files?.length) return;
            const reader = new FileReader();
            reader.addEventListener('load', () => {
                this.image = reader.result?.toString() ?? '';
                this.imageFile = this.input.files?.[0] ?? null;
            });
            // eslint-disable-next-line unicorn/prefer-add-event-listener
            reader.onerror = () => {
                this.image = '';
                this.imageFile = null;
            };
            reader.readAsDataURL(this.input.files[0]);
        });
        this.lightbox.finishLoading('avatar-edit-mounted');
    },
});
</script>

<style scoped lang="sass">
.well
    text-align: center
</style>
