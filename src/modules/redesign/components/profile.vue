<template>
    <div>
        <h1 class="redesign-profile-title" :id="profile.id">
            <img
                :src="`/images/user_${profile.online ? 'green' : 'gray'}.png`"
                alt=""
            />
            {{ profile.name }}
        </h1>
        <div class="profile-content">
            <div class="pull-left profile-sidebar">
                <div class="btn-toolbar pull-right profile-btns">
                    <div class="btn-group" v-if="profile.self">
                        <a
                            class="btn btn-default btn-xs"
                            lightbox-open
                            href="/profile/edit?close-after-submit"
                            :title="lightbox.$sm('buttons.edit')"
                        >
                            <font-awesome-icon
                                :icon="faEdit"
                            ></font-awesome-icon>
                        </a>
                        <a
                            class="btn btn-default btn-xs"
                            lightbox-open
                            href="/avatar?close-after-submit"
                            :title="lightbox.$sm('buttons.avatar')"
                        >
                            <font-awesome-icon
                                :icon="faImage"
                            ></font-awesome-icon>
                        </a>
                    </div>
                    <div class="btn-group" v-if="profile.can_alliance_ignore">
                        <button
                            class="btn btn-xs"
                            :class="`btn-${
                                profile.alliance_ignored ? 'warning' : 'danger'
                            }`"
                            :title="
                                lightbox.$sm(
                                    `buttons.alliance_ignore.${
                                        !profile.alliance_ignored
                                            ? 'add'
                                            : 'destroy'
                                    }`
                                )
                            "
                            @click="allianceIgnore"
                        >
                            alliance ignore {{ !profile.alliance_ignored }}
                        </button>
                    </div>
                    <div class="btn-group" v-if="profile.ban.length">
                        <div v-if="profile.ban[0] !== 0">
                            <button
                                class="btn btn-danger dropdown-toggle btn-xs"
                                data-toggle="dropdown"
                                :title="lightbox.$sm(`buttons.chat.ban`)"
                            >
                                ban chat <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li v-for="time in profile.ban" :key="time">
                                    <a
                                        :href="`/profile/${profile.id}/chatban/${time}`"
                                    >
                                        {{
                                            moment
                                                .duration(time, 'seconds')
                                                .humanize()
                                        }}
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <a
                            v-else
                            :href="`/profile/${profile.id}/chatban/0`"
                            class="btn btn-warning btn-xs"
                            :title="lightbox.$sm(`buttons.chat.unban`)"
                        >
                            unban chat
                        </a>
                    </div>
                    <div class="btn-group" v-if="!profile.self">
                        <a
                            class="btn btn-xs"
                            :class="`btn-${
                                profile.ignored ? 'warning' : 'danger'
                            }`"
                            :href="`/ignoriert/${
                                profile.ignored ? 'entfernen' : 'hinzufuegen'
                            }/${profile.id}?user=${encodeURIComponent(
                                profile.id
                            )}`"
                            :title="
                                lightbox.$sm(
                                    `buttons.ignore.${
                                        profile.ignored ? 'undo' : 'do'
                                    }`
                                )
                            "
                        >
                            <font-awesome-icon
                                :icon="profile.ignored ? faUnlock : faLock"
                            ></font-awesome-icon>
                        </a>
                        <a
                            v-if="!profile.ignored"
                            class="btn btn-xs"
                            :class="`btn-${
                                profile.friend ? 'danger' : 'success'
                            }`"
                            :href="`/freunde/${
                                profile.friend ? 'entfernen' : 'hinzufuegen'
                            }/${profile.id}?user=${encodeURIComponent(
                                profile.id
                            )}`"
                            :title="
                                lightbox.$sm(
                                    `buttons.friend.${
                                        profile.friend ? 'undo' : 'do'
                                    }`
                                )
                            "
                        >
                            <font-awesome-icon
                                :icon="
                                    profile.friend ? faUserSlash : faUserFriends
                                "
                            ></font-awesome-icon>
                        </a>
                    </div>
                    <div
                        class="btn-group"
                        v-if="!profile.self && !profile.ignored"
                    >
                        <a
                            class="btn btn-success btn-xs"
                            lightbox-open
                            :href="`/messages/new?target=${encodeURIComponent(
                                profile.name
                            )}`"
                            :title="lightbox.$sm('buttons.message')"
                        >
                            <font-awesome-icon
                                :icon="faEnvelope"
                            ></font-awesome-icon>
                        </a>
                        <a
                            class="btn btn-success btn-xs"
                            lightbox-open
                            :href="`/coins?gift_for_user=${encodeURIComponent(
                                profile.id
                            )}`"
                            :title="lightbox.$sm('buttons.gift')"
                        >
                            <font-awesome-icon
                                :icon="faGift"
                            ></font-awesome-icon>
                        </a>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div v-if="profile.friend" class="alert alert-success">
                    {{ lightbox.$sm('alerts.friend', { name: profile.name }) }}
                </div>
                <div v-if="profile.ignored" class="alert alert-danger">
                    {{ lightbox.$sm('alerts.ignored', { name: profile.name }) }}
                </div>
                <div v-if="profile.alliance_ignored" class="alert alert-danger">
                    {{
                        lightbox.$sm('alerts.alliance_ignored', {
                            name: profile.name,
                        })
                    }}
                </div>
                <div class="well">
                    <div>
                        <b>{{ lightbox.$sm('rank') }}</b>
                        : {{ rank }}
                    </div>
                    <div v-if="profile.registration">
                        <b>{{ lightbox.$sm('registration') }}</b>
                        : {{ moment(profile.registration).format('LLLL') }}
                    </div>
                    <div>
                        {{
                            lightbox.$sm('credits', {
                                credits: profile.credits.toLocaleString(),
                            })
                        }}
                    </div>
                    <div v-if="profile.alliance">
                        {{ lightbox.$sm('alliance') }}:
                        <a :href="`/alliances/${profile.alliance.id}`">
                            {{ profile.alliance.name }}
                        </a>
                        <ul
                            v-if="
                                allianceUser &&
                                (allianceUser.roles.length ||
                                    allianceUser.caption)
                            "
                            class="alliance-roles"
                        >
                            <li v-for="role in allianceUser.roles" :key="role">
                                {{ role }}
                            </li>
                            <li v-if="allianceUser.caption">
                                <span class="label label-default">
                                    {{ allianceUser.caption }}
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
                <a
                    v-if="profile.self"
                    href="/auszeichnungen"
                    lightbox-open
                    class="btn btn-default btn-xs pull-right"
                >
                    {{ lightbox.$sm('awards.own') }}
                </a>
                <div class="clearfix"></div>
                <img
                    v-if="profile.image"
                    :src="profile.image"
                    alt=""
                    class="profile-image"
                />
                <div :id="awardsChartId"></div>
            </div>
            <div class="profile-tabs">
                <tabs
                    ref="tabs"
                    :on-select="
                        (_, i) => {
                            show_map = profile.has_map && i === 1;
                            if (
                                show_map &&
                                Object.values($refs.map.map.getSize()).includes(
                                    0
                                )
                            )
                                $nextTick($refs.map.redraw);
                        }
                    "
                >
                    <tab :title="lightbox.$sm('text')">
                        <div v-html="profile.text.replace(/\n/g, '<br>')"></div>
                    </tab>
                    <tab v-if="profile.has_map" :title="lightbox.$sm('map')">
                        <div class="dispatchcenter-summary">
                            <span
                                class="label"
                                :class="`label-${
                                    hiddenFilters.length ? 'danger' : 'success'
                                }`"
                                @click="toggleAllFilters"
                            >
                                {{
                                    lightbox.$smc(
                                        'buildings.amount',
                                        profile.buildings.length,
                                        {
                                            n: profile.buildings.length.toLocaleString(),
                                        }
                                    )
                                }}
                            </span>
                            <template
                                v-for="type in buildingTypesSorted.filter(
                                    t => buildings[0].buildingTypes.sum[t]
                                )"
                            >
                                <span
                                    class="label"
                                    :class="`label-${
                                        hiddenFilters.includes(type)
                                            ? 'danger'
                                            : 'success'
                                    }`"
                                    :key="type"
                                    @click="toggleFilter(type)"
                                    @dblclick="onlyFilter(type)"
                                >
                                    {{ buildingTypes[type].caption }}:
                                    {{
                                        buildings[0].buildingTypes.sum[
                                            type
                                        ].toLocaleString()
                                    }}
                                </span>
                            </template>
                        </div>
                    </tab>
                    <tab
                        v-if="profile.has_map"
                        :title="
                            lightbox.$smc(
                                'buildings.amount',
                                profile.buildings.length,
                                {
                                    n: profile.buildings.length.toLocaleString(),
                                }
                            )
                        "
                    >
                        <label class="pull-right">
                            <input
                                type="search"
                                class="search_input_field"
                                v-model="search"
                            />
                        </label>
                        <div class="dispatchcenter-summary">
                            <span
                                class="label"
                                :class="`label-${
                                    hiddenFilters.length ? 'danger' : 'success'
                                }`"
                                @click="toggleAllFilters"
                            >
                                {{
                                    lightbox.$smc(
                                        'buildings.amount',
                                        profile.buildings.length,
                                        {
                                            n: profile.buildings.length.toLocaleString(),
                                        }
                                    )
                                }}
                            </span>
                            <template
                                v-for="type in buildingTypesSorted.filter(
                                    t => buildings[0].buildingTypes.sum[t]
                                )"
                            >
                                <span
                                    class="label"
                                    :class="`label-${
                                        hiddenFilters.includes(type)
                                            ? 'danger'
                                            : 'success'
                                    }`"
                                    :key="type"
                                    @click="toggleFilter(type)"
                                    @dblclick="onlyFilter(type)"
                                >
                                    {{ buildingTypes[type].caption }}:
                                    {{
                                        buildings[0].buildingTypes.sum[
                                            type
                                        ].toLocaleString()
                                    }}
                                </span>
                            </template>
                        </div>
                        <div
                            class="panel panel-default profile-dispatchcenter"
                            v-for="dc in dispatchCentersSorted"
                            :key="dc.id"
                        >
                            <div
                                class="panel-heading"
                                @click="
                                    expandedDispatches.includes(dc.id)
                                        ? expandedDispatches.splice(
                                              expandedDispatches.findIndex(
                                                  n => n === dc.id
                                              ),
                                              1
                                          )
                                        : expandedDispatches.push(dc.id)
                                "
                            >
                                <span class="pull-right">{{
                                    lightbox.$smc(
                                        'buildings.amount',
                                        (dc.buildings || []).length,
                                        {
                                            n: (
                                                dc.buildings || []
                                            ).length.toLocaleString(),
                                        }
                                    )
                                }}</span>
                                <h3 class="panel-title">
                                    <font-awesome-icon
                                        class="map-locator"
                                        v-if="dc.id"
                                        :icon="faMapMarkedAlt"
                                        @click.stop="
                                            () => {
                                                $refs.tabs.onSelect(
                                                    undefined,
                                                    1
                                                );
                                                $set(
                                                    $refs.tabs,
                                                    'selectedIndex',
                                                    1
                                                );
                                                $refs.map.setView(
                                                    dc.latitude,
                                                    dc.longitude
                                                );
                                            }
                                        "
                                    ></font-awesome-icon>
                                    <img
                                        loading="lazy"
                                        :src="
                                            dc.id
                                                ? dc.icon
                                                : '/images/building_leitstelle.png'
                                        "
                                        :alt="dc.name"
                                    />
                                    <a
                                        :href="`/buildings/${dc.id}`"
                                        v-if="dc.id"
                                    >
                                        {{ he.decode(dc.name) }}
                                    </a>
                                </h3>
                            </div>
                            <div
                                class="panel-body"
                                v-if="
                                    expandedDispatches.includes(dc.id) &&
                                    dc.buildingTypes
                                "
                            >
                                <div class="dispatchcenter-summary">
                                    <span
                                        v-for="type in buildingTypesSorted"
                                        :key="type"
                                    >
                                        <span
                                            class="label label-default"
                                            v-if="dc.buildingTypes[type]"
                                        >
                                            {{ buildingTypes[type].caption }}:
                                            {{
                                                dc.buildingTypes[
                                                    type
                                                ].toLocaleString()
                                            }}
                                        </span>
                                    </span>
                                </div>
                                <div class="profile-grid">
                                    <div
                                        class="panel panel-default"
                                        v-for="building in dc.buildings"
                                        :key="building.id"
                                        :class="{
                                            hidden:
                                                (search &&
                                                    !building.name
                                                        .toLowerCase()
                                                        .trim()
                                                        .match(
                                                            search
                                                                .toLowerCase()
                                                                .trim()
                                                        )) ||
                                                hiddenFilters.includes(
                                                    building.building_type
                                                ),
                                        }"
                                    >
                                        <div class="panel-heading">
                                            <span
                                                class="pull-right label label-default"
                                            >
                                                {{
                                                    buildingTypes[
                                                        building.building_type
                                                    ].caption
                                                }}
                                            </span>
                                            <h3 class="panel-title">
                                                <font-awesome-icon
                                                    class="map-locator"
                                                    :icon="faMapMarkedAlt"
                                                    @click="
                                                        () => {
                                                            $refs.tabs.onSelect(
                                                                undefined,
                                                                1
                                                            );
                                                            $set(
                                                                $refs.tabs,
                                                                'selectedIndex',
                                                                1
                                                            );
                                                            $refs.map.setView(
                                                                building.latitude,
                                                                building.longitude
                                                            );
                                                        }
                                                    "
                                                ></font-awesome-icon>
                                                <img
                                                    loading="lazy"
                                                    :src="building.icon"
                                                    :alt="building.name"
                                                />
                                                <a
                                                    class="lightbox-open"
                                                    :href="`/buildings/${building.id}`"
                                                >
                                                    {{
                                                        he.decode(building.name)
                                                    }}
                                                </a>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </tab>
                    <tab
                        v-if="profile.awards.length"
                        :title="lightbox.$sm('awards.title')"
                    >
                        <div class="profile-awards profile-grid">
                            <div
                                class="panel panel-default"
                                v-for="award in profile.awards"
                                :key="award.caption"
                            >
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        {{ award.caption }}
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <img
                                        loading="lazy"
                                        :alt="award.caption"
                                        :src="award.image"
                                    />
                                    <p>{{ award.desc }}</p>
                                </div>
                            </div>
                        </div>
                    </tab>
                </tabs>
                <leaflet-map
                    v-if="profile.has_map"
                    v-show="show_map"
                    ref="map"
                    :id="`profile-${profile.id}-map-${lightbox.creation}`"
                    :start-lat="
                        profile.buildings.length
                            ? profile.buildings[0].latitude
                            : void 0
                    "
                    :start-long="
                        profile.buildings.length
                            ? profile.buildings[0].longitude
                            : void 0
                    "
                    :layers="
                        Object.entries(mapLayerGroups)
                            .filter(
                                ([t]) => !hiddenFilters.includes(parseInt(t))
                            )
                            .map(([, l]) => l)
                    "
                ></leaflet-map>
            </div>
        </div>
    </div>
</template>

<script lang="ts">
import Vue from 'vue';

import { faEdit } from '@fortawesome/free-solid-svg-icons/faEdit';
import { faEnvelope } from '@fortawesome/free-solid-svg-icons/faEnvelope';
import { faGift } from '@fortawesome/free-solid-svg-icons/faGift';
import { faImage } from '@fortawesome/free-solid-svg-icons/faImage';
import { faLock } from '@fortawesome/free-solid-svg-icons/faLock';
import { faMapMarkedAlt } from '@fortawesome/free-solid-svg-icons/faMapMarkedAlt';
import { faUnlock } from '@fortawesome/free-solid-svg-icons/faUnlock';
import { faUserFriends } from '@fortawesome/free-solid-svg-icons/faUserFriends';
import { faUserSlash } from '@fortawesome/free-solid-svg-icons/faUserSlash';
import he from 'he';
import Highcharts from 'highcharts';
import HighchartsMore from 'highcharts/highcharts-more';
import HighchartsSolidGauge from 'highcharts/modules/solid-gauge';
import moment from 'moment';
import { useEventStore } from '@stores/event';

import type { IconDefinition } from '@fortawesome/fontawesome-svg-core';
import type { InternalBuilding } from 'typings/Building';
import type { LayerGroup } from 'leaflet';
import type { MapVue } from 'typings/components/LeafletMap';
// to separate typings
// eslint-disable-next-line no-duplicate-imports
import type { PlotGaugeOptions } from 'highcharts';
import type { ProfileWindow } from '../parsers/profile';
import type { RedesignComponent } from 'typings/modules/Redesign';
import type { TranslateResult } from 'vue-i18n';
import type { User } from 'typings/api/AllianceInfo';

HighchartsMore(Highcharts);
HighchartsSolidGauge(Highcharts);

type DispatchCenter = Record<
    number,
    Partial<ProfileWindow['buildings'][0]> & {
        buildings: ProfileWindow['buildings'];
        buildingTypes: {
            [type: number]: number;
            sum?: Record<number, number>;
        };
    }
>;

type Component = RedesignComponent<
    'profile',
    'profile',
    {
        moment: typeof moment;
        he: typeof he;
        faEdit: IconDefinition;
        faImage: IconDefinition;
        faEnvelope: IconDefinition;
        faGift: IconDefinition;
        faMapMarkedAlt: IconDefinition;
        faUserFriends: IconDefinition;
        faUserSlash: IconDefinition;
        faLock: IconDefinition;
        faUnlock: IconDefinition;
        awardsChartId: string;
        maxAwards: number;
        buildingTypes: Record<number, InternalBuilding>;
        buildingTypesSorted: number[];
        mapLayerGroups: Record<number, LayerGroup>;
        buildingMarkerIds: number[];
        expandedDispatches: number[];
        search: string;
        hiddenFilters: number[];
        show_map: boolean;
        allianceUser: User | undefined;
    },
    {
        allianceIgnore(): void;
        toggleFilter(type: number): void;
        onlyFilter(type: number): void;
        toggleAllFilters(): void;
    },
    {
        rank: string;
        awardColors: {
            bronze: number;
            silver: number;
            gold: number;
        };
        buildings: DispatchCenter;
        dispatchCentersSorted: DispatchCenter[number][];
    }
>;

export default Vue.extend<
    Component['Data'],
    Component['Methods'],
    Component['Computed'],
    Component['Props']
>({
    name: 'lssmv4-redesign-profile',
    components: {
        LeafletMap: () =>
            import(
                /* webpackChunkName: "components/leafletMap" */ '../../../components/LeafletMap.vue'
            ),
    },
    data() {
        moment.locale(this.lightbox.rootStore.locale);
        const buildingTypes = this.lightbox.translationStore.buildings;
        return {
            moment,
            he,
            faEdit,
            faImage,
            faEnvelope,
            faGift,
            faMapMarkedAlt,
            faUserFriends,
            faUserSlash,
            faLock,
            faUnlock,
            awardsChartId: this.lightbox.rootStore.nodeAttribute(
                'redesign-profile-awards-gauge-chart',
                true
            ),
            maxAwards: 0,
            buildingTypes,
            buildingTypesSorted: Object.keys(buildingTypes)
                .map(t => parseInt(t))
                .sort((a, b) =>
                    buildingTypes[a].caption < buildingTypes[b].caption
                        ? -1
                        : buildingTypes[a].caption > buildingTypes[b].caption
                          ? 1
                          : 0
                ),
            mapLayerGroups: Object.fromEntries(
                Object.keys(buildingTypes).map(type => [
                    parseInt(type),
                    window.L.layerGroup(),
                ])
            ),
            buildingMarkerIds: [],
            expandedDispatches: [],
            search: '',
            hiddenFilters: [],
            show_map: false,
            allianceUser: undefined,
        };
    },
    methods: {
        allianceIgnore() {
            const url = new URL(window.location.origin);
            url.searchParams.append('_method', 'post');
            url.searchParams.append(
                'authenticity_token',
                this.profile.authenticity_token
            );
            this.lightbox.apiStore
                .request(
                    `/allianceIgnore/${this.profile.id}/${
                        this.profile.alliance_ignored ? 'destroy' : 'add'
                    }`,
                    `redesign-profile-allianceignore-${
                        this.profile.id
                    }-to-${!this.profile.alliance_ignored}`,
                    {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        referrer: new URL(
                            `profile/${this.profile.id}`,
                            window.location.origin
                        ).toString(),
                        body: url.searchParams.toString(),
                        method: 'POST',
                        mode: 'cors',
                    }
                )
                .then(() =>
                    this.$set(
                        this.lightbox,
                        'src',
                        `/profile/${this.profile.id}`
                    )
                );
        },
        toggleFilter(type) {
            if (this.hiddenFilters.includes(type)) {
                this.hiddenFilters.splice(this.hiddenFilters.indexOf(type), 1);
                (this.$refs.map as MapVue)?.map?.addLayer(
                    this.mapLayerGroups[type]
                );
            } else {
                this.hiddenFilters.push(type);
                (this.$refs.map as MapVue)?.map?.removeLayer(
                    this.mapLayerGroups[type]
                );
            }
            this.setSetting('hiddenFilters', this.hiddenFilters).then();
        },
        onlyFilter(type) {
            this.hiddenFilters = Object.keys(
                this.buildings[0].buildingTypes.sum ?? {}
            )
                .filter(t => {
                    (this.$refs.map as MapVue)?.map?.[
                        t === type.toString() ? 'addLayer' : 'removeLayer'
                    ](this.mapLayerGroups[parseInt(t)]);
                    return t !== type.toString();
                })
                .map(t => parseInt(t));
            this.setSetting('hiddenFilters', this.hiddenFilters).then();
        },
        toggleAllFilters() {
            if (
                Object.keys(this.buildings[0].buildingTypes.sum ?? {}).every(
                    type => this.hiddenFilters.includes(parseInt(type))
                )
            ) {
                this.hiddenFilters.forEach(type =>
                    this.$nextTick().then(() => this.toggleFilter(type))
                );
            } else {
                this.onlyFilter(-1);
            }
        },
    },
    computed: {
        rank() {
            const ranks = this.$t(
                `ranks.${this.lightbox.rootStore.gameFlavour}`
            ) as Record<number, string>;
            return (
                Object.entries(ranks)
                    .reverse()
                    .find(
                        ([credits]) => parseInt(credits) <= this.profile.credits
                    )?.[1] ?? ''
            );
        },
        awardColors() {
            const colors = {
                bronze: 0,
                silver: 0,
                gold: 0,
            };
            this.profile.awards.forEach(({ image }) => {
                if (image.match(/award_bronze/u)) colors.bronze++;
                else if (image.match(/award_silver/u)) colors.silver++;
                else if (image.match(/award_gold/u)) colors.gold++;
            });
            return colors;
        },
        buildings() {
            const dispatchCenters: DispatchCenter = {
                0: { buildings: [], id: 0, buildingTypes: { sum: {} } },
            };
            this.profile.buildings.forEach(
                (building: ProfileWindow['buildings'][0]) => {
                    if (!this.buildingMarkerIds.includes(building.id)) {
                        const img = document.createElement('img');
                        img.src = building.icon;
                        img.addEventListener('load', () =>
                            this.mapLayerGroups[
                                building.building_type
                            ].addLayer(
                                window.L.marker(
                                    [building.latitude, building.longitude],
                                    {
                                        icon: window.L.icon({
                                            iconUrl: building.icon,
                                            iconSize: [
                                                img.naturalWidth,
                                                img.naturalHeight,
                                            ],
                                        }),
                                        title: building.name,
                                    }
                                )
                                    .bindTooltip(building.name)
                                    .on('click', () =>
                                        window.lightboxOpen(
                                            `/buildings/${building.id}`
                                        )
                                    )
                            )
                        );
                        this.buildingMarkerIds.push(building.id);
                    }
                    if (dispatchCenters[0].buildingTypes.sum) {
                        if (
                            !dispatchCenters[0].buildingTypes.sum.hasOwnProperty(
                                building.building_type
                            )
                        ) {
                            dispatchCenters[0].buildingTypes.sum[
                                building.building_type
                            ] = 0;
                        }
                        dispatchCenters[0].buildingTypes.sum[
                            building.building_type
                        ]++;
                    }
                    if (building.filter_id === 'dispatch_center') {
                        return (dispatchCenters[building.id] = {
                            ...dispatchCenters[building.id],
                            ...building,
                        });
                    }
                    if (!dispatchCenters.hasOwnProperty(building.lbid)) {
                        dispatchCenters[building.lbid] = {
                            buildings: [],
                            buildingTypes: {},
                        };
                    }
                    if (
                        !dispatchCenters[building.lbid].hasOwnProperty(
                            'buildings'
                        )
                    )
                        dispatchCenters[building.lbid].buildings = [];
                    if (
                        !dispatchCenters[building.lbid].hasOwnProperty(
                            'buildingTypes'
                        )
                    )
                        dispatchCenters[building.lbid].buildingTypes = {};
                    dispatchCenters[building.lbid].buildings.push(building);
                    if (
                        !dispatchCenters[
                            building.lbid
                        ].buildingTypes.hasOwnProperty(building.building_type)
                    ) {
                        dispatchCenters[building.lbid].buildingTypes[
                            building.building_type
                        ] = 0;
                    }
                    dispatchCenters[building.lbid].buildingTypes[
                        building.building_type
                    ]++;
                }
            );
            return dispatchCenters;
        },
        dispatchCentersSorted() {
            return Object.values(this.buildings).sort(
                ({ name: a }, { name: b }) =>
                    (a ?? '') < (b ?? '') ? -1 : (a ?? '') > (b ?? '') ? 1 : 0
            );
        },
    },
    props: {
        profile: {
            type: Object,
            required: true,
        },
        url: {
            type: String,
            required: true,
        },
        lightbox: {
            type: Object,
            required: true,
        },
        getSetting: {
            type: Function,
            required: true,
        },
        setSetting: {
            type: Function,
            required: true,
        },
    },
    watch: {
        profile() {
            this.lightbox.finishLoading('profile-updated');
        },
    },
    mounted() {
        const eventStore = useEventStore();
        eventStore.addListener({
            name: 'redesign-edit-profile-submitted',
            listener: ({ detail: { content } }: CustomEvent) => {
                if (this.profile.self)
                    this.$set(this.lightbox.data, 'text', content);
            },
        });
        eventStore.addListener({
            name: 'redesign-edit-avatar-submitted',
            listener: ({ detail: { img } }: CustomEvent) => {
                if (this.profile.self)
                    this.$set(this.lightbox.data, 'image', img);
            },
        });
        this.getSetting('hiddenFilters', []).then(
            f => (this.hiddenFilters = f)
        );
        this.lightbox.apiStore
            .getAllianceInfo('redesign-profile')
            .then(allianceinfo => {
                this.allianceUser = allianceinfo.users.find(
                    ({ id }) => id === this.profile.id
                );
            });
        this.maxAwards = parseInt(this.lightbox.$sm('awards.max').toString());
        if (this.lightbox.rootStore.isDarkMode)
            Highcharts.setOptions(this.$utils.highChartsDarkMode);
        Highcharts.setOptions({
            lang: {
                ...(this.$t('highcharts') as Record<string, TranslateResult>),
            },
        });
        Highcharts.chart(this.awardsChartId, {
            chart: {
                type: 'solidgauge',
                height: 200,
            },
            title: {
                text: this.lightbox.$sm('awards.title_amounts', {
                    sum: this.profile.awards.length,
                    max: this.maxAwards,
                }),
                margin: 0,
                style: {
                    fontWeight: 'bold',
                },
            },
            tooltip: {
                borderWidth: 0,
                backgroundColor: 'none',
                shadow: false,
                style: {
                    fontSize: '16px',
                },
                valueSuffix: '',
                pointFormat:
                    '{series.name}<br><span style="font-size:2em; color: {point.color}; font-weight: bold">{point.y}</span>',
                positioner(labelWidth: number) {
                    return {
                        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                        // @ts-ignore
                        x: (this.chart.chartWidth - labelWidth) / 2,
                        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                        // @ts-ignore
                        y: this.chart.plotHeight / 2 + 15,
                    };
                },
            },
            pane: {
                startAngle: 0,
                endAngle: 360,
                background: [
                    {
                        // Track for Gold
                        outerRadius: '112%',
                        innerRadius: '88%',
                        backgroundColor: Highcharts.color('#f6cd4f')
                            .setOpacity(0.3)
                            .get(),
                        borderWidth: 0,
                    },
                    {
                        // Track for Silver
                        outerRadius: '87%',
                        innerRadius: '63%',
                        backgroundColor: Highcharts.color('#b6b6b6')
                            .setOpacity(0.3)
                            .get(),
                        borderWidth: 0,
                    },
                    {
                        // Track for Bronze
                        outerRadius: '62%',
                        innerRadius: '38%',
                        backgroundColor: Highcharts.color('#cd7f32')
                            .setOpacity(0.3)
                            .get(),
                        borderWidth: 0,
                    },
                ],
            },
            yAxis: {
                min: 0,
                max: this.maxAwards,
                lineWidth: 0,
                tickPositions: [],
            },
            plotOptions: {
                solidgauge: {
                    dataLabels: {
                        enabled: false,
                    },
                    linecap: 'round',
                    stickyTracking: false,
                    rounded: true,
                },
            },
            series: [
                {
                    name: this.lightbox.$sm('awards.gold').toString(),
                    data: [
                        {
                            color: '#f6cd4f',
                            radius: '112%',
                            innerRadius: '88%',
                            y: this.awardColors.gold,
                        },
                    ],
                },
                {
                    name: this.lightbox.$sm('awards.silver').toString(),
                    data: [
                        {
                            color: '#b6b6b6',
                            radius: '87%',
                            innerRadius: '63%',
                            y: this.awardColors.silver,
                        },
                    ],
                },
                {
                    name: this.lightbox.$sm('awards.bronze').toString(),
                    data: [
                        {
                            color: '#cd7f32',
                            radius: '62%',
                            innerRadius: '38%',
                            y: this.awardColors.bronze,
                        },
                    ],
                },
            ],
        } as PlotGaugeOptions);
        this.lightbox.finishLoading('profile-mounted');
    },
});
</script>

<style lang="sass" scoped>
.profile-content
    display: flex

    .profile-sidebar
        margin-right: 1rem

        .profile-btns
            margin-bottom: 1rem

        .profile-image
            min-width: 90%
            display: block
            margin: auto

        .alliance-roles
            list-style: none
            margin-bottom: 0

            li
                list-style: none

    .profile-tabs
        width: 100%

        .profile-dispatchcenter

            > .panel-heading
                cursor: pointer

                .panel-title img
                    max-height: calc(16px + 1em)

            .profile-grid::before,
            .profile-grid::after
                content: unset

        .dispatchcenter-summary
            display: flex
            flex-flow: wrap
            margin-bottom: 1rem
            user-select: none

            span.label
                margin: 0 .5em

                &.label-success,
                &.label-danger
                    cursor: pointer

        .profile-awards .panel-body
            display: flex
            flex-flow: row

            img
                max-width: 50%

            p
                margin-left: 10px


        .profile-grid
            display: grid
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))
            grid-gap: 1em

.map-locator
    cursor: pointer
</style>
