<template>
    <div class="panel panel-default">
        <div class="panel-heading">
            <font-awesome-icon :icon="icon"></font-awesome-icon>
            <span
                v-if="type === 'vehicles'"
                class="building_list_fms"
                :class="`building_list_fms_${vehicle.fms_real}`"
                >{{ vehicle.fms_show }}</span
            >
            <a :href="link" class="lightbox-open" :class="previewLinkClass">
                {{ title }}
            </a>
            <br v-if="additional" />
            <small v-if="additional">
                {{ additional }}
            </small>
        </div>
        <div class="panel-body">
            <span v-if="type === 'vehicles'">
                <a
                    class="lightbox-open pull-right"
                    :class="previewLinkClass"
                    :href="`/buildings/${vehicle.building_id}`"
                >
                    {{
                        buildings.find((b) => b.id === vehicle.building_id)
                            .caption
                    }}
                </a>
            </span>
            <table v-else-if="type === 'buildings'">
                <tr v-for="vehicle in buildingVehicles" :key="vehicle.id">
                    <td>
                        <span
                            class="building_list_fms"
                            :class="`building_list_fms_${vehicle.fms_real}`"
                            >{{ vehicle.fms_show }}</span
                        >
                    </td>
                    <td>
                        <a
                            class="lightbox-open"
                            :class="previewLinkClass"
                            :href="`/vehicles/${vehicle.id}`"
                        >
                            {{ vehicle.caption }}
                        </a>
                    </td>
                    <td>
                        ({{ vehicleTypes[vehicle.vehicle_type].caption }}
                        <small v-if="vehicle.vehicle_type_caption"
                            >[{{ vehicle.vehicle_type_caption }}]</small
                        >)
                    </td>
                </tr>
            </table>
        </div>
    </div>
</template>

<script lang="ts">
import Vue from 'vue';
import {
    LinkPreviewMethods,
    LinkPreview,
    LinkPreviewComputed,
    LinkPreviewProps,
} from 'typings/modules/GeneralExtensions/LinkPreview';
import { InternalVehicle } from 'typings/Vehicle';
import { InternalBuilding } from 'typings/Building';

export default Vue.extend<
    LinkPreview,
    LinkPreviewMethods,
    LinkPreviewComputed,
    LinkPreviewProps
>({
    name: 'linkPreview',
    data() {
        return {
            icon: 'question',
            type: '',
            id: 0,
            title: '',
            additional: '',
            mouse: {
                x: 0,
                y: 0,
            },
            vehicleTypes: (this.$t('vehicles') as unknown) as InternalVehicle[],
            building: null,
            vehicle: null,
        } as LinkPreview;
    },
    props: {
        previewLinkClass: {
            type: String,
            required: true,
        },
    },
    computed: {
        link() {
            return `/${this.type}/${this.id}`;
        },
        parent() {
            return this.$el.parentElement;
        },
        buildings() {
            return this.$store.state.api.buildings;
        },
        vehicles() {
            return this.$store.getters['api/vehiclesByBuilding'];
        },
        buildingVehicles() {
            return (
                this.vehicles[this.id]?.sort((a, b) =>
                    a.caption > b.caption ? 1 : b.caption > a.caption ? -1 : 0
                ) || []
            );
        },
    },
    methods: {
        _resetAll() {
            this._setIcon();
            this._setType('');
            this._setTitle('');
            this._setId(0);
            this._setAdditional('');
            this.building = null;
            this.vehicle = null;
        },
        _setIcon(icon) {
            if (!icon) icon = 'question';
            this.icon = icon;
        },
        _setType(type) {
            this.type = type;
        },
        _setTitle(title) {
            this.title = title;
        },
        _setId(id) {
            this.id = id;
        },
        _setAdditional(additional) {
            this.additional = additional;
        },
        setMousePosition(x: number, y: number) {
            this.mouse = { x, y };
        },
        setBuilding(building, icon) {
            this._resetAll();
            this.building = building;
            this._setId(building.id);
            this._setType('buildings');
            this._setTitle(building.caption);
            this._setIcon(icon);
            this._setAdditional(
                ((this.$t('buildings') as unknown) as InternalBuilding[])[
                    building.building_type
                ].caption
            );
        },
        setVehicle(vehicle) {
            this._resetAll();
            this.vehicle = vehicle;
            this._setId(vehicle.id);
            this._setType('vehicles');
            this._setTitle(vehicle.caption);
            this._setIcon('ambulance');
            let additional = this.vehicleTypes[vehicle.vehicle_type].caption;
            if (vehicle.vehicle_type_caption)
                additional += ` | ${vehicle.vehicle_type_caption}`;
            this._setAdditional(additional);
        },
        setUser(id) {
            this._resetAll();
            this._setId(id);
            this._setType('profile');
            this._setTitle(`User: ${id}`);
            this._setIcon('user');
        },
        setMission(id) {
            this._resetAll();
            this._setId(id);
            this._setType('mission');
            this._setTitle(`Mission: ${id}`);
            this._setIcon('phone-alt');
        },
    },
    updated() {
        if (!this.parent) return;
        const infoBoxBCR = this.$el.getBoundingClientRect();
        let top = this.mouse.y - infoBoxBCR.height;
        if (top < 0) top = this.mouse.y;
        if (top + infoBoxBCR.height > window.innerHeight)
            top -= top + infoBoxBCR.height - window.innerHeight;
        let left = this.mouse.x - infoBoxBCR.width / 2;
        if (left < 0) left = 0;
        if (left + infoBoxBCR.width > window.innerWidth)
            left -= left + infoBoxBCR.width - window.innerWidth;
        this.parent.style.top = `${top}px`;
        this.parent.style.left = `${left}px`;
    },
});
</script>

<style scoped lang="sass">
.panel-default
    position: fixed
    z-index: 2000

    .svg-inline--fa
        margin-right: 1rem
</style>
