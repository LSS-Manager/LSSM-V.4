name: Build Project

on:
    workflow_call:

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            mode: ${{ steps.output.outputs.mode }}
            type: ${{ steps.output.outputs.type }}
            version: ${{ steps.output.outputs.version }}
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: '[â¬†] set yarn to stable'
              run: |
                  corepack enable
                  yarn set version stable

            - name: '[â„¹] print versions (node, yarn, git)'
              run: |
                  echo "node: $(node -v) â€“ yarn: $(yarn -v) â€“ git: $(git --version)"

            - name: '[â¬†] update browserslist'
              run: npx -y browserslist@latest --update-db

            - name: '[ğŸ±] yarn install'
              run: yarn install --immutable

            - name: '[ğŸŒ³] set env variables (e.g. beta/stable for webpack & target dir)'
              run: |
                  echo "MODE=$(if ${{ github.ref == 'refs/heads/master' }}; then echo "production"; else echo "development"; fi)" >> $GITHUB_ENV
                  echo "TYPE=$(if ${{ github.ref == 'refs/heads/master' }}; then echo "stable"; else echo "beta"; fi)" >> $GITHUB_ENV

            - name: '[â¬†] update emojis'
              run: ./node_modules/.bin/ts-node scripts/utils/fetchEmojis.ts

            - name: '[ğŸš¨] sort JSONs'
              run: ./node_modules/.bin/ts-node scripts/sort.ts || exit 1

            - name: '[ğŸš¨] run ESLint'
              run: |
                  ./scripts/lint_fix.sh || exit 1
                  yarn tsc -b --pretty "./" || exit 1

            - name: '[ğŸ“œ] build userscript'
              run: yarn tsc --pretty "src/userscript.ts" || exit 1

            - name: '[ğŸš§] run prebuild'
              run: ./node_modules/.bin/ts-node prebuild/index.ts || exit 1

            - name: '[ğŸ‘·] webpack'
              run: |
                  ./node_modules/.bin/ts-node build/index.ts --esModuleInterop "${{ env.MODE }}" || exit 1
                  git --no-pager diff --color-words

            - name: '[ğŸ“] build docs'
              run: |
                  ./docs/.vuepress/node_modules/.bin/vuepress build docs || exit 1
                  mkdir -p ./dist/docs
                  rm -rdf ./dist/docs/*
                  cp -r ./docs/.vuepress/dist/* ./dist/docs

            - name: '[ğŸ’¬] set output'
              id: output
              run: |
                  echo "::set-output name=mode::${{ env.MODE }}"
                  echo "::set-output name=type::${{ env.TYPE }}"
                  echo "VERSION=$(grep '"version":' package.json | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[:space:]')"
                  echo "::set-output name=version::$VERSION"

            - name: '[ğŸ“¦] zip files'
              run: |
                  sudo apt-get install zip
                  zip -r dist.zip dist

            - name: '[â˜ï¸] upload artifact'
              if: ${{ success() || failure() }}
              uses: actions/upload-artifact@v2
              with:
                  name: LSSM_V4-${{ github.sha }}
                  path: dist.zip
                  if-no-files-found: error
                  retention-days: 1
